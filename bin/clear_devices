#!/usr/bin/php
<?php

################################################################################
# Load Cisco Marking Configuration Values                                      #
################################################################################
if (($cisco_configs = parse_ini_file(getenv("CISCO_PATH") . "/config.ini", true)) === false)
{
  echo "\n\033[1;31;40mERROR: \033[0;37;40m Reading Cisco configuration file: " . getenv("CISCO_PATH") . "/config.ini\n";
  exit(1);
}

################################################################################
# Load the provided system_functions library                                   #
################################################################################
require_once("{$cisco_configs["lib_path"]}/system_functions.php");

################################################################################
# Include libraries to access a device via ssh(Swinburne ATC lab setup).       #
################################################################################
require_once("{$cisco_configs["lib_path"]}/consolessh.php");

################################################################################
# Include libraries to talk to and capture stuff from a device (password       #
# support is still crap                                                        #
################################################################################
$password = "cisco";

require_once("{$cisco_configs["lib_path"]}/devicecontrol.php");

if (version_compare(PHP_VERSION, '5.4.0') >= 0) {
  require_once("{$cisco_configs["lib_path"]}/http_request.php");
}

################################################################################
#          >>>>>>>>>> FETCH DEVICE INFORMATION FUNCTIONS <<<<<<<<<<            #
################################################################################
# Servers to contact to download information about device allocation and access#
# information from for each room in the ATC building                           #
################################################################################
$atc_servers = array(8 => array("description" => "Cisco Devices in ATC328",
                                "url"         => "https://ictencsvr1.ict.swin.edu.au/agent/get_all.php",
                               ),

                     9 => array("description" => "Cisco Devices in ATC329",
                                "url"         => "https://ictencsvr6.ict.swin.edu.au/agent/get_all.php",
                               ),

                     0 => array("description" => "Cisco Devices in ATC330",
                                "url"         => "https://ictencsvr11.ict.swin.edu.au/agent/get_all.php",
                               )
                    );

################################################################################
# Menu items to help select sub-sets of devices                                #
################################################################################
$rack_filters = array(".+" => "All Enclosures", "Black" => "Black Enclosure", "Red" => "Red Enclosure", "Blue" => "Blue Enclosure", "Green" => "Green Enclosure", "Yellow" => "Yellow Enclosure");

$kit_filters = array(".+" => "All Kits", "White" => "White Kit", "Purple" => "Purple Kit", "Orange" => "Orange Kit", "Green" => "Green Kit", "Yellow" => "Yellow Kit");

$device_filters = array("Router 1", "Router 2", "Router 3", "Router 4", "Switch 1", "Switch 2", "Switch 3", "Switch 4");

################################################################################
################################################################################
function AskTerminate()
{
  if (DisplayYesNo("Terminate Program", "Are you sure that you want to terminate upload now?", "Upload Device Configuration"))
    exit(1);
}

################################################################################
# GetATCServerList()                                                           #
#                                                                              #
# Asks the user which rooms to upload device configurations to. The list of    #
# possible rooms is in the global $atc_servers variable. A dialog box with a   #
# checklist of rooms is displayed, allowing users the option of terminating    #
# the program. We loop repeatedly until the user quits or selects at least one #
# room. The selected rooms are returned in an array of indexes to the global   #
# $atc_servers array                                                           #
################################################################################
function GetATCServerList()
{
  global $atc_servers;

  foreach ($atc_servers as $key => $details) $items[$key] = $details["description"];

  while (true)
  {
    $choice = DisplayCheckList(" ATC Room Selection ",
                               "Please select which rooms you would like to upload router configurations to",
                               $items,
                               "Upload Device Configuration",
                               '--cancel-label "Quit"'
                              );

    switch ($choice->code)
    {
      case 0:
        $selected = array_filter(explode(" ", $choice->output));
        array_walk($selected, create_function('&$val', '$val = trim($val, \'"\');'));
        if (count($selected) > 0) return $selected;

        DisplayMessage(" ATC Room Selection ",
                       "ERROR: You must select at least one room to upload device configurations to",
                       "Upload Device Configuration"
                      );
        break;
      default:
        AskTerminate();
    }
  }
}

################################################################################
# GetAuthDetails()                                                             #
#                                                                              #
# Asks user for their SIMS username and password. Allows user to terminate the #
# program. We loop repeatedly until the user quits or enters some details.     #
# Entered password is hashed out for privacy, entered details are returned as  #
# an array                                                                     #
################################################################################
function GetAuthDetails()
{
  while (true)
  {
    exec('dialog --backtitle "Upload Device Configuration" \
                 --stdout --colors --insecure --cancel-label "Quit" \
                 --title " ATC Website Authentication Information " \
                 --mixedform "Enter Swinburne SIMS Details below:\n" 25 70 15 \
                             "Username:" 2 2 "" 2 15 50 50 0 \
                             "Password:" 4 2 "" 4 15 50 50 1',
         $output, $result);

    echo "\n";
    if ($result == 0) return array("username" => $output[0], "password" => $output[1]);

    AskTerminate();
  }
}

################################################################################
# FetchRoomDetails($url, $auth_details)                                        #
#                                                                              #
# Connects to the specified URL using the provided authentication details and  #
# attempts to download device details for the corresponding room. Possible     #
# outcomes are:                                                                #
#  - Error connecting to server, terminate program with error message          #
#  - No devices booked by user, return false                                   #
#  - Return content of response, list of pre-formatted device details          #
################################################################################
function FetchRoomDetails($url, $auth_details)
{
  $httpquery = new HttpRequest();

  $httpquery->setURL($url);
  $httpquery->setMethod(HttpRequest::METH_POST);
  $httpquery->setPostFields($auth_details);
  $httpquery->send();

  if ($httpquery->getResponseCode() != 200)
  {
    DisplayMessage(" ERROR Accessing Site ", "Unable to connect to $url, this is a terminal problem", "Upload Device Configuration");
    exit(1);
  }

  $result = $httpquery->getResponseData();

  if ($result["body"] == "Logon error\n")
  {
    DisplayMessage(" ERROR Authenticating ", "Bad username/password combination supplied");
    return false;
  }

  return $result["body"];
}

################################################################################
# DownloadDeviceDetails($server_list, $description)                            #
#                                                                              #
# Returns an array containing all the downloaded device details from the       #
# nominated ATC servers                                                        #
#  - Loop through each room we are uploading to                                #
#    o Attempt to fetch the details of devices for that room                   #
#      - FetchRoomDetails() will terminate on a major error or return false if #
#        authentication fails                                                  #
#    o While authentication fails, re-query the user for username/password     #
#    o Append the returned details to the return string                        #
#  - All OK, break the downloaded data into an array for the function response #
#  - If no devices available, terminate with an error message                  #
################################################################################
function DownloadDeviceDetails()
{
  global $atc_servers, $server_list, $auth_details;

  $devices = "";
  
  foreach ($server_list as $index)
  {
    DisplayStatus(" Fetching Device Connection Details ", $atc_servers[$index]["description"], "Upload Device Configuration");
    while (($details = FetchRoomDetails($atc_servers[$index]["url"], $auth_details)) == false)
    {
      $auth_details = GetAuthDetails();
      DisplayStatus(" Fetching Device Connection Details ", $atc_servers[$index]["description"], "Upload Device Configuration");
    }
    $devices.= $details;
  }

  $device_list = explode("\n", trim($devices));

  if (count($device_list) > 0) return $device_list;

  echo "\033[1;31;40mERROR:\033[0;37;40m You have no devices available to upload to\n";
  exit(1);
}

################################################################################
# GetRackFilter($current_filter)                                               #
#                                                                              #
# Displays a checkbox menu of all items in $rack_filters, with the items as    #
# selected in $current_filter already selected. Loop until at least one item   #
# is selected, also ensure that if the "All Racks" items is selected (".+"),   #
# then no other items are selected. Return a string containing all selected    #
# items, joined with a '|', ready to use in a regular expression.              #
################################################################################
function GetRackFilter($current_filter)
{
  global $rack_filters;

  while (true)
  {
    $choice = DisplayCheckList("Rack/Enclosure Selection",
                               "Please select which racks/enclosures you would like to upload router configurations to",
                               $rack_filters,
                               "Upload Device Configuration",
                               '--cancel-label "Cancel"',
                               $current_filter
                              );

    switch ($choice->code)
    {
      case 0:
        # remove the '\' (in front of '*' and any quotation marks, then replace spaces with pipes
        $new_filter = strtr(str_replace('"', '', $choice->output), ' ', '|');

        if (strlen($new_filter) > 0)
        {
          if ((strpos($new_filter, ".+") === FALSE) || (strlen($new_filter) == 2)) return $new_filter;
          DisplayMessage("Rack/Enclosure Selection",
                         "ERROR: Cannot select individual enclosures if 'All Enclosures' are selected",
                         "Upload Device Configuration"
                        );
        } else
        {
          DisplayMessage("Rack/Enclosure Selection",
                         "ERROR: You must select at least one rack/enclosure to upload device configurations to",
                         "Upload Device Configuration"
                        );
        }
        break;
      default:
        return $current_filter;
    }
  }
}

################################################################################
# GetKitFilter($current_filter)                                                #
#                                                                              #
# Displays a checkbox menu of all items in $kit_filters, with the items as     #
# selected in $current_filter already selected. Loop until at least one item   #
# is selected, also ensure that if the "All kits" items is selected (".+"),    #
# then no other items are selected. Return a string containing all selected    #
# items, joined with a '|', ready to use in a regular expression.              #
################################################################################
function GetKitFilter($current_filter)
{
  global $kit_filters;

  while (true)
  {
    $choice = DisplayCheckList("Kit Selection",
                               "Please select which kits you would like to upload router configurations to",
                               $kit_filters,
                               "Upload Device Configuration",
                               '--cancel-label "Cancel"',
                               $current_filter
                              );

    switch ($choice->code)
    {
      case 0:
        # remove the '\' (in front of '*' and any quotation marks, then replace spaces with pipes
        $new_filter = strtr(str_replace('"', '', $choice->output), ' ', '|');

        if (strlen($new_filter) > 0)
        {
          if ((strpos($new_filter, ".+") === FALSE) || (strlen($new_filter) === 2)) return $new_filter;

          DisplayMessage("Kit Selection",
                         "ERROR: Cannot select individual enclosures if 'All Kits' are selected",
                         "Upload Device Configuration"
                        );
        } else
        {
          DisplayMessage("Kit Selection",
                         "ERROR: You must select at least one kit to upload device configurations to",
                         "Upload Device Configuration"
                        );
        }
        break;
      default:
        return $current_filter;
    }
  }
}

################################################################################
# GetDeviceFilter($current_filter)                                             #
#                                                                              #
# Displays a radio button menu of all items in $device_filters, with the item  #
# as selected in $current_filter already selected. If the user doesn't cancel  #
# the new selection, return the newly selected item, otherwise return the      #
# old selection.                                                               #
################################################################################
function GetDeviceFilter($current_filter)
{
  global $device_filters;

  $choice = DisplayRadioList("Device Selection",
                             "Please select which device within a kit you would like to upload router configurations to",
                             $device_filters,
                             "Upload Device Configuration",
                             '',
                             $current_filter
                            );

  switch ($choice->code)
  {
    case 0:  return $device_filters[$choice->output];
    default: return $current_filter;
  }
}

################################################################################
# RunFilter($device_list, $filter)                                             #
#                                                                              #
# Applies the specified filter to the list of all devices and return an array  #
# of structured data that can be used to connect to those devices. The filter  #
# ($filter) is a PCRE Regular Expression matched against the device name       #
# portion of each line in $device_list. The line is exploded into separate     #
# fields before being structured for insertion into the return array           #
################################################################################
function RunFilter($device_list, $filter)
{
  foreach ($device_list as $data_line)
  {
    if (strlen($data_line) == 0) continue;
    $data = str_getcsv($data_line, ":");

    if (strlen($data[7]) == 0) $device_name = $data[5]; else $device_name = $data[7];

    if (preg_match($filter, $device_name) !== 1) continue;

    $device_db[$device_name . ' (' . $data[1] . ')'] = array("server" => $data[1],
                                                             "username" => $data[2],
                                                             "password" => $data[3],
                                                             "fullname" => $data[5],
                                                             "nickname" => $device_name
                                                            );
  }

  return $device_db;
}

################################################################################
# FilterManual($device_list)                                                   #
#                                                                              #
# Allow user to apply a manual filter to match the "end" of the device name    #
# from the provided list of device details. We loop continuously over the      #
# dialog box with a single entry field. The text displays which devices match  #
# the current filter while an input box allows the user to apply a new filter. #
# There are four options:                                                      #
#  Filter - Apply the new filter and get a new list of selected devices        #
#  Upload - Begin the upload of configuration to selected devices. Returns the #
#           list of selected devices in structured array                       #
#  Quit   - Terminate upload and program, check with user first                #
#  Auto   - Switch from manual filtering to rule based filtering by returning  #
#           result of FilterDevices()                                          #
################################################################################
function FilterManual($device_list)
{
  $manual_filter = "1";
  while (true)
  {
    $filter = "/$manual_filter$/";
    $device_db = RunFilter($device_list, $filter);

    $message = 'Selected Devices:\n  ';
    $message.= (count($device_db) <= 10)?((count($device_db) == 0)?'ERROR: No devices selected':implode('\n  ', array_keys($device_db))):(count($device_db) . ' total devices match the filters');
    $message.= '\n\nModify the filter below, the filter will match all devices ending in the specified text';

    $choice = DisplayInput("Filter Devices", $message, $manual_filter,
                           "Upload Device Configuration",
                           '--ok-label "Filter" --extra-button --extra-label "Upload" --cancel-label "Quit" --help-button --help-label "Auto Filter"'
                          );

    switch ($choice->code)
    {
      // New filter entered
      case 0: $manual_filter = $choice->output; break;

      // Quit selected
      case 1: AskTerminate(); break;

      // Auto Filter selected
      case 2: return FilterDevices($device_list); break;

      // Upload selected
      default:
        if (count($device_db) > 0) return $device_db;

        DisplayMessage("Device Selection/Filtering", "ERROR: You must select at least one device to upload configurations to", "Upload Device Configuration");
    }
  }
}

################################################################################
# FilterDevices($device_list)                                                  #
#                                                                              #
# Allow user to apply a group of filters to match a subset of devices from the #
# provided list of device details. We loop continuously over the menu dialog   #
# box. There are three menu items to adjust one of three concurrently applied  #
# filters. The text displays the current filters and which devices match these #
# filters. The overall filter is a regular expression constructed from the     #
# individual filters. There are four options:                                  #
#  OK     - Modify the currently selected filter based on the menu item. Call  #
#           the appropriate function to query for - and return - the new       #
#           filter                                                             #
#  Upload - Begin the upload of configuration to selected devices. Returns the #
#           list of selected devices in structured array                       #
#  Quit   - Terminate upload and program, check with user first                #
#  Manual - Switch from rule based filtering to manual filtering by returning  #
#           result of FilterManual()                                           #
################################################################################
function FilterDevices($device_list)
{
  $menu_items = array("Rack"   => "Modify Filter to select Rack(s)",
                      "Kit"    => "Modify Filter to select Kit(s)",
                      "Device" => "Modify Filter to select Devices"
                     );

  $rack_filter = $kit_filter = ".+";
  $device_filter = "Router 1";
  
  while (true)
  {
    $filter = "/Enclosure \d \(($rack_filter)\).+Kit \d \(($kit_filter)\).+$device_filter/";
    $device_db = RunFilter($device_list, $filter);

    $message = 'Current Filters:\n  Rack:   ' . $rack_filter . '\n  Kit:    ' . $kit_filter . '\n  Device: ' . $device_filter . '\n\nSelected Devices:\n  ';
    $message.= (count($device_db) <= 15)?((count($device_db) == 0)?'ERROR: No devices selected':implode('\n  ', array_keys($device_db))):(count($device_db) . ' total devices match the filters');
    $message.= '\n\nUse the menu items below to modify any of the filters, select Upload to begin uploading configurations';
    $choice = DisplayMenu("Filter Devices", $message, $menu_items, 
                          "Upload Device Configuration",
                          '--extra-button --extra-label "Upload" --cancel-label "Quit" --help-button --help-label "Manual Filter"'
                         );

    switch ($choice->code)
    {
      // Menu item selected
      case 0:
        switch ($choice->output)
        {
          case "Rack":   $rack_filter   = GetRackFilter($rack_filter);     break;
          case "Kit":    $kit_filter    = GetKitFilter($kit_filter);       break;
          case "Device": $device_filter = GetDeviceFilter($device_filter); break; 
        }
        break;

      // Quit selected
      case 1: AskTerminate(); break;

      // Manual Filter selected
      case 2: return FilterManual($device_list); break;

      // Upload selected
      default:
        if (count($device_db) > 0) return $device_db;

        DisplayMessage("Device Selection/Filtering", "ERROR: You must select at least one device to upload configurations to", "Upload Device Configuration");
    }
  }
}

################################################################################
# FetchDeviceList()                                                            #
#                                                                              #
# Returns a subset of devices in the ATC labs along with connection details.   #
# The subset is the devices to upload the specified configuration to           #
# - Call GetATCServerList() to select which rooms to configure (list stored in #
#   $server_list)                                                              #
# - Call GetAuthDetails() to request username/password combination to use when #
#   connecting to the ATC servers (details stored in $auth_details)            #
# - Call DownloadDeviceDetails() to download connection details for ALL booked #
#   devices in selected rooms (details stored in $device_list)                 #
# - Return result of FilterDevices() to allow user to select a subset of       #
#   devices from $device_list. The result is structured to allow for easy      #
#   connection using the remainder of the application.                         #
################################################################################
function FetchDeviceList()
{
  global $server_list, $auth_details;

  $server_list = GetATCServerList();
  $auth_details = GetAuthDetails();

  $device_list = DownloadDeviceDetails();

  return FilterDevices($device_list);
}

################################################################################
#                >>>>>>>>>> CHILD PROCESS FUNCTIONS <<<<<<<<<<                 #
################################################################################
# sig_child($signal)                                                           #
#                                                                              #
# Called whenever a child process dies, this can happen in three ways:         #
#  1) success                                                                  #
#  2) failure                                                                  #
#  3) termination                                                              #
#                                                                              #
# Wait for a particular process to cleanup (pcntl_wait()) in a loop (so we     #
# handle all dead processes in the handler (we return when no more terminated  #
# child processes exist. For each terminated child process ($pid):             #
# - Get the $device_name allocated to that child process                       #
# - If the process was killed, set the error_message data field in $device_db  #
#   for this device to reflect what happened                                   #
# - If the process terminated but returned failure, set the error_message data #
#   field in $device_db for this device to reflect what happened and increment #
#   the $borked_pids count so we know how many have failed pre-maturely        #
# - Otherwise the collection worked OK, we remove the $pid from the list of    #
#   child PIDs ($child_pid) so we know which processes are still executing     #
################################################################################
function sig_child($signal)
{
  global $device_db, $child_pids, $borked_pids;

  while(($pid = pcntl_wait($status, WNOHANG)) > 0)
  {
    $device_name = $child_pids[$pid];

    if (!pcntl_wifexited($status))
      $device_db[$device_name]["error_message"] = "Collection process timed-out and was forcibly terminated";
    else if (pcntl_wexitstatus($status) > 0) 
    {
      $device_db[$device_name]["error_message"] = "Collection process returned failure";
      $borked_pids++;
    } else
    {
      unset($child_pids[$pid]);
    }
  }
}

################################################################################
# Redraw the visual display with regard to progress using a "mixedgauge"       #
# dialog box.                                                                  #
# NEEDS MORE COMMENTS
################################################################################
function DisplayProgress($title, $text, $percent, $items, $backtitle = NULL, $other_options = NULL)
{
  $gauge_options = '--mixedgauge "' . $text . '" 30 70 ' . $percent;
  foreach ($items as $description => $percentage) 
  {
    $gauge_options.= ' "' . $description . '" "' . $percentage . '"';
  }

  if ($backtitle === NULL) $backtitle = BackTitle();

  exec('dialog --backtitle "' . $backtitle . '" --stdout --colors \
               --title " ' . $title . ' " \
               ' . $other_options . ' ' . $gauge_options,
       $output, $result);

}

################################################################################
# Countdown_Delay($delay)                                                      #
#                                                                              #
# Print a countdown timer and return when finished. In each second (moderated  #
# by sleep(1)), dispatch waiting signals, this allows children to terminate    #
# properly                                                                     #
################################################################################
function Countdown_Delay($delay)
{
  global $child_pids, $borked_pids;

  $total_jobs = count($child_pids);

  $progress_items = array();

  for ($count = $delay; $count > 0; $count--)
  {
    $progress_items["Countdown time remaining:"] = "$count(s)";
    $progress_items["Running processes:"]        = count($child_pids) . " jobs";
    $progress_items["Failed processes:"]         = "$borked_pids jobs";

    $percent_complete = 100 - (100 * (count($child_pids) + $borked_pids) / $total_jobs);

#    DisplayProgress("Upload progress", "Overall percentage of completed uploads", $percent_complete,
#                    $progress_items, "Upload Device Configuration");
    echo "==============================================================\n";
    echo ">>>>>> $total_jobs - $child_pids ($percent_complete) <<<<<<<<<<<\n";

    // Terminate loop early if there are no more child processes running
    if (count($child_pids) === 0) return;

    // Terminate loop early if the remaining child processes are all borked
    if ($borked_pids === count($child_pids)) return;

    // Pause and continue
    sleep(1);
    pcntl_signal_dispatch();
  }
}

################################################################################
# TerminateChildren($child_pids)                                               #
#                                                                              #
# Terminate all children in the provided list of processes (and wait for the   #
# process to actually die                                                      #
################################################################################
function TerminateChildren($child_pids)
{
  $total_children = count($child_pids);
  echo "Terminating unfinished processes";
  $count = 0;
  foreach ($child_pids as $pid => $device_details)
  {
    if (posix_kill($pid, 0))
    {
      DisplayProgress("Terminating unfinished processes", "", 100 * $count / count(child_pids), array("Terminating:"=>"Pid($pid)"), "Upload Device Configuration");
      posix_kill($pid, SIGINT);
    }
    pcntl_waitpid($pid, $status);
  }
}

################################################################################
# ChildProcess_UploadDevice($device_name)                                      #
#                                                                              #
# This function uploads the provided configurarion commands to the specified   #
# device.                                                                      #
#                                                                              #
# - Connect to the device and try to go to enable mode. If we fail, terminate  #
#   with failure.  The main loop will retry later on. As this function will    #
#   run in a child process, we exit the process with failure                   #
# - We are now in enable mode                                                  #
# - Send the "conf t" command to go into configuration mode                    #
# - Loop through each of the provided commands, sending them to the device one #
#   at a time                                                                  #
# - Go back to enable mode. We could send the actual commands, but it is safer #
#   to use the pre-provided function                                           #
# - Execute "copy run start" to save the configuration                         #
# - Exit the child process with a success code                                 #
################################################################################
function ChildProcess_ClearDevice($device_name)
{
  global $device_db, $device_commands;

  $return_code = 0;

  // Turn output off as we have parallel threads
//  ob_start();

  // Create classes to connect and talk to the devices
  $ssh = new ConsoleSSH();
  $console = new DeviceControl($ssh);

  // Connect to the device and go to enable mode. If unsuccessful, terminate with failure

  if (($ssh->Connect($device_db[$device_name])) === false) { $return_code = 1; goto terminate; };

  if ($console->GoEnable(false) === false) { $return_code = 1; goto terminate; }

  // Erase startup-config 
  $console->EraseSwitch();

terminate:
  // Parallel processing, turn output back on, kill process (this is a child)
  sleep(1);
  $ssh->Disconnect();
  sleep(1);
  ob_end_clean();
  exit($return_code);
}

################################################################################
#                 >>>>>>>>>> MAIN PROCESS FUNCTIONS <<<<<<<<<<                 #
################################################################################
# UploadDevices($group_name)                                                   #
#                                                                              #
# This function collects the output of executing all commands specified in     #
# $exam_details(global) for all devices/students configured in $device_db      #
# (global) and writes output files based on the provided class/group name      #
# ($group_name)                                                                #
#                                                                              #
# - Loop through each device name we are clearing                              #
#   - Fork a child process and call ChildProcess_ClearDevice() to erase all    #
#     configurations on this device. This function always terminates the child #
#     process so all continuing code is the parent process                     #
#   - Store the child process PID as well as the student id and device name    #
#     allocated to this child process to collect                               #
#                                                                              #
# - Sleep the parent process for a delay period to give the collection child   #
#   processes a chance to successfully terminate.                              #
# - If any child processes are still running ($child_pids), forcibly terminate #
#   them                                                                       #
#                                                                              #
# $child_pids contains a list of all devices we failed to collect from         #
# - Rebuild $device_db with only the contents for devices listed in $child_pids#
# - If $device_db is non-empty, return false to indicate a failure to collect  #
################################################################################
function ClearDevices()
{
  global $device_db, $child_pids, $borked_pids;

  $pid = 0;
  $borked_pids = 0;
  $child_pids = array();

  // Loop through each device in turn
  foreach ($device_db as $device_name => $device_details)
  {
    // Parallel processing, launch a child process to capture output from
    // the device. This process will terminate when completed
    if (($pid = pcntl_fork()) == 0) ChildProcess_ClearDevice($device_name);

    // Store the process ID so we know which devices were collected by which processes
    $child_pids[$pid] = $device_name;
  }

  // Give upload processes a chance to succeed
  Countdown_Delay(180);

  // $child_pids contains list of processes we need to terminate
  if (count($child_pids) > 0) TerminateChildren($child_pids);

  // Use list of $child_pids to build a new, cut-down version of $device_db
  $fail_list = array();
  foreach ($child_pids as $pid => $device_name)
  {
    $fail_list[$device_name] = $device_db[$device_name];
    $fail_list[$device_name]["error_message"] = "Clearing process was forcibly terminated";
    unset($child_pids[$pid]);
  }
  $device_db = $fail_list;

  // If there is still something in $device_db, we failed and need to try again
  if (count($device_db) > 0) return false;
}

################################################################################
# MAIN PROGRAM                                                                 #
################################################################################
# Parse command line parameters                                                #
################################################################################
// Check command line parameters
if (count($argv) != 1)
{
  echo "Usage: $argv[0]\n";
  echo "";
  exit(1);
}

// Download device details to upload configs to from ATC web server
$device_db = FetchDeviceList();

// Install signal handler to handle when a child(collection process dies)
pcntl_signal(SIGCHLD, "sig_child");

// Upload everything
while (ClearDevices() === false)
{
  $message = "------------------------------------------------------------------------------------------------------\n";
  $message.= "Student #\tDevice Details\n";
  $message.= "------------------------------------------------------------------------------------------------------\n";
  foreach ($device_db as $student_id => $devices)
    foreach ($devices as $device_name => $details)
      $message.= "$student_id\t" . $details["fullname"] . "($device_name)\t" . $details["error_message"] . "\n";
  $message.= "------------------------------------------------------------------------------------------------------\n\n";
  $message.= "Please try to repair these configurations, and then select whether we should try to collect them again\n";
#  if (!DisplayYesNo("Failed to collect configs for the following devices", 
#                    $message,
#                    $exam_details["Exam Details"]["name"]
#                   ))      
    exit(1);
}

?>
